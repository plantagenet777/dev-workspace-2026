# PdM stack: pump_monitor + mosquitto
services:
  # Main monitoring service
  pump_monitor:
    build: .
    container_name: pump_monitor_service
    # on-failure avoids infinite restart loops on syntax/runtime errors
    restart: on-failure
    env_file: .env
    depends_on:
      - mosquitto
    volumes:
      - ./certs:/app/certs:ro
      - ./logs:/app/logs
      - ./models:/app/models
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - MQTT_USE_TLS=false
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "python3 app/healthcheck.py"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Local MQTT broker (sandbox)
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: pump_mosquitto
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
    restart: unless-stopped
